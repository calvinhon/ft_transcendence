export interface TournamentMatch {
  tournamentId: string;
  matchId: string;
  player1Id: number;
  player1Name: string;
  player2Id: number;
  player2Name: string;
  originalPlayer1Id?: number;
  originalPlayer2Id?: number;
}

import { logger } from '../utils/Logger';
import { getTournamentManager } from './tournament';
import { authService } from '../core/authService';
import { appManager } from './app/AppManager';

export class TournamentGameManager {
  public async recordMatchResult(
    tournamentId: string,
    matchId: string,
    winnerId: number,
    player1Score: number,
    player2Score: number
  ): Promise<void> {
    const tournamentManager = getTournamentManager();

    if (!tournamentManager || !tournamentManager.recordMatchResult) {
      throw new Error('Tournament manager not available');
    }

    return tournamentManager.recordMatchResult(
      Number(tournamentId),
      Number(matchId),
      winnerId,
      player1Score,
      player2Score
    );
  }

  public handleTournamentGameEnd(
    gameData: any,
    tournamentMatch: TournamentMatch,
    onResultShown: (playerWon: boolean, scoreText: string) => void
  ): void {
    console.log('üèÜ [TOURNAMENT] ========== GAME END HANDLER ==========');
    console.log('üèÜ [TOURNAMENT] Game ended with data:', gameData);

    const user = authService?.getCurrentUser();

    if (!user) {
      logger.error('TournamentGameManager', 'No user logged in');
      return;
    }

    console.log('üèÜ [TOURNAMENT] Tournament match data:', {
      matchId: tournamentMatch.matchId,
      player1Id: tournamentMatch.player1Id,
      player2Id: tournamentMatch.player2Id,
      player1Name: tournamentMatch.player1Name,
      player2Name: tournamentMatch.player2Name,
      originalPlayer1Id: tournamentMatch.originalPlayer1Id,
      originalPlayer2Id: tournamentMatch.originalPlayer2Id
    });

    // Get the winner from game (this is based on displayed positions)
    const gameWinnerId = (typeof gameData.winner === 'number') ? gameData.winner : gameData.winnerId;
    const playerWon = gameWinnerId === user.userId;

    // Get final scores (based on displayed positions)
    const scores = gameData.scores || { player1: 0, player2: 0 };
    const finalScoreText = `${scores.player1} - ${scores.player2}`;

    console.log('üèÜ [TOURNAMENT] Game result:', {
      gameWinnerId,
      gameScores: scores,
      currentUserId: user.userId || user.id,
      playerWon
    });

    // Map back to original tournament player IDs if sides were swapped
    const originalPlayer1Id = tournamentMatch.originalPlayer1Id || tournamentMatch.player1Id;
    const originalPlayer2Id = tournamentMatch.originalPlayer2Id || tournamentMatch.player2Id;
    const werePlayersSwapped = tournamentMatch.player1Id !== originalPlayer1Id;

    console.log('üèÜ [TOURNAMENT] Player mapping:', {
      displayedPlayer1: tournamentMatch.player1Id,
      displayedPlayer2: tournamentMatch.player2Id,
      originalPlayer1: originalPlayer1Id,
      originalPlayer2: originalPlayer2Id,
      werePlayersSwapped
    });

    let actualWinnerId = gameWinnerId;
    let actualPlayer1Score = scores.player1;
    let actualPlayer2Score = scores.player2;

    if (werePlayersSwapped) {
      // Players were swapped for display, need to map back to original IDs
      console.log('üîÑ [TOURNAMENT] Players were swapped, mapping back to original IDs');
      console.log('üîÑ [TOURNAMENT] Understanding the swap:');
      console.log('  - Displayed LEFT (player1) is actually:', originalPlayer2Id);
      console.log('  - Displayed RIGHT (player2) is actually:', originalPlayer1Id);
      console.log('  - Game scores.player1 (LEFT) is originalPlayer2 score:', scores.player1);
      console.log('  - Game scores.player2 (RIGHT) is originalPlayer1 score:', scores.player2);

      // Swap the scores back to match original player order
      actualPlayer1Score = scores.player2;
      actualPlayer2Score = scores.player1;

      console.log('üîÑ [TOURNAMENT] After remapping to original positions:', {
        originalPlayer1Score: actualPlayer1Score,
        originalPlayer2Score: actualPlayer2Score
      });
    } else {
      console.log('‚úÖ [TOURNAMENT] No swap - players in original positions');
      console.log('  - LEFT (player1) is originalPlayer1:', originalPlayer1Id);
      console.log('  - RIGHT (player2) is originalPlayer2:', originalPlayer2Id);
      console.log('  - Scores match original positions');
    }

    // CRITICAL FIX: Always determine winner based on the FINAL scores and original player IDs
    // Don't trust the game's winnerId because it's based on displayed positions
    if (actualPlayer1Score > actualPlayer2Score) {
      actualWinnerId = originalPlayer1Id;
      console.log('üèÜ Winner is originalPlayer1 (higher score):', originalPlayer1Id);
    } else if (actualPlayer2Score > actualPlayer1Score) {
      actualWinnerId = originalPlayer2Id;
      console.log('üèÜ Winner is originalPlayer2 (higher score):', originalPlayer2Id);
    } else {
      // Tie - this shouldn't happen in tournament mode, but default to game's winner
      console.warn('üèÜ [TOURNAMENT] WARNING: Tie score detected! Using game winner ID:', gameWinnerId);
      actualWinnerId = gameWinnerId;
    }

    console.log('üèÜ [TOURNAMENT] Winner determination:', {
      gameReportedWinner: gameWinnerId,
      player1Score: actualPlayer1Score,
      player2Score: actualPlayer2Score,
      calculatedWinnerId: actualWinnerId,
      isOriginalPlayer1: actualWinnerId === originalPlayer1Id,
      isOriginalPlayer2: actualWinnerId === originalPlayer2Id
    });

    console.log('üèÜ [TOURNAMENT] Final result to record:', {
      tournamentId: tournamentMatch.tournamentId,
      matchId: tournamentMatch.matchId,
      winnerId: actualWinnerId,
      originalPlayer1Id: originalPlayer1Id,
      originalPlayer2Id: originalPlayer2Id,
      player1Score: actualPlayer1Score,
      player2Score: actualPlayer2Score
    });

    // Verify winner is one of the original players
    if (actualWinnerId !== originalPlayer1Id && actualWinnerId !== originalPlayer2Id) {
      logger.error('TournamentGameManager', 'Winner ID does not match any original player', {
        winnerId: actualWinnerId,
        originalPlayer1Id,
        originalPlayer2Id
      });
      alert('Error: Invalid winner ID. Please report this bug.');
      return;
    }

    // Record match result
    this.recordMatchResult(
      tournamentMatch.tournamentId,
      tournamentMatch.matchId,
      actualWinnerId,
      actualPlayer1Score,
      actualPlayer2Score
    ).then(() => {
      console.log('‚úÖ [TOURNAMENT] Match result recorded successfully');

      // Clear current tournament match to prevent replay
      const app = appManager as any;
      if (app) {
        app.currentTournamentMatch = null;
      }

      // Show result message
      onResultShown(playerWon, finalScoreText);

      // Reset UI and navigate back after delay
      setTimeout(() => {
        // Navigation and cleanup will be handled by the main GameManager
      }, 3000);
    }).catch((error: any) => {
      logger.error('TournamentGameManager', 'Failed to record match result', error);
      alert('Failed to record match result: ' + (error.message || 'Unknown error'));
    });

    console.log('üèÜ [TOURNAMENT] ========== END HANDLER COMPLETE ==========');
  }
}