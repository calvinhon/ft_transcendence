name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [auth-service, game-service, tournament-service, user-service, frontend, blockchain]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: ${{ matrix.service }}
        run: npm ci
      
      - name: Run npm audit
        working-directory: ${{ matrix.service }}
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > audit-report.json || true
      
      - name: Check for high severity vulnerabilities
        working-directory: ${{ matrix.service }}
        run: |
          HIGH_VULNS=$(npm audit --audit-level=high --json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(npm audit --audit-level=high --json | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "High severity vulnerabilities: $HIGH_VULNS"
          echo "Critical severity vulnerabilities: $CRITICAL_VULNS"
          
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "❌ Critical vulnerabilities found!"
            npm audit --audit-level=critical
            exit 1
          fi
          
          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "⚠️  High severity vulnerabilities found"
            npm audit --audit-level=high
          fi
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report-${{ matrix.service }}
          path: ${{ matrix.service }}/audit-report.json

  dockerfile-security:
    name: Dockerfile Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Hadolint on Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          recursive: true
          ignore: DL3008,DL3009
          failure-threshold: warning

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  docker-image-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        service: [auth-service, game-service, tournament-service, user-service, frontend, blockchain]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          load: true
          tags: ${{ matrix.service }}:scan
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  security-headers:
    name: Security Headers Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check nginx security headers
        run: |
          echo "Checking nginx configuration for security headers..."
          
          # Check for security headers in nginx.conf
          required_headers=(
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Referrer-Policy"
          )
          
          for header in "${required_headers[@]}"; do
            if ! grep -q "$header" frontend/nginx/nginx.conf; then
              echo "⚠️  Warning: $header not found in nginx.conf"
            else
              echo "✅ $header configured"
            fi
          done
      
      - name: Check CORS configuration
        run: |
          echo "Checking CORS configuration..."
          
          if grep -q "Access-Control-Allow-Origin" frontend/nginx/nginx.conf; then
            echo "✅ CORS configured"
          else
            echo "⚠️  CORS not found in nginx.conf"
          fi

  security-report:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, dockerfile-security, secret-scan, security-headers]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dependency scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dockerfile security check completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Secret scanning completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security headers verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job results for details." >> $GITHUB_STEP_SUMMARY
