name: Performance Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run performance tests weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'

jobs:
  load-test:
    name: Load Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Start services
        run: |
          docker compose up -d
          sleep 30
      
      - name: Install Apache Bench
        run: sudo apt-get update && sudo apt-get install -y apache2-utils
      
      - name: Load test auth service
        run: |
          echo "Testing auth service login endpoint..."
          ab -n 1000 -c 10 -p <(echo '{"username":"testuser","password":"test123"}') \
            -T 'application/json' \
            http://localhost/api/auth/health > auth-load-test.txt
          
          cat auth-load-test.txt
      
      - name: Load test game service
        run: |
          echo "Testing game service health endpoint..."
          ab -n 1000 -c 10 http://localhost/api/game/health > game-load-test.txt
          
          cat game-load-test.txt
      
      - name: Load test tournament service
        run: |
          echo "Testing tournament service health endpoint..."
          ab -n 1000 -c 10 http://localhost/api/tournament/health > tournament-load-test.txt
          
          cat tournament-load-test.txt
      
      - name: Load test user service
        run: |
          echo "Testing user service health endpoint..."
          ab -n 1000 -c 10 http://localhost/api/user/health > user-load-test.txt
          
          cat user-load-test.txt
      
      - name: Check response times
        run: |
          echo "Checking response times..."
          
          # Extract mean response time from ab output
          extract_time() {
            grep "Time per request:" $1 | head -1 | awk '{print $4}'
          }
          
          AUTH_TIME=$(extract_time auth-load-test.txt)
          GAME_TIME=$(extract_time game-load-test.txt)
          TOURNAMENT_TIME=$(extract_time tournament-load-test.txt)
          USER_TIME=$(extract_time user-load-test.txt)
          
          echo "Auth service: ${AUTH_TIME}ms"
          echo "Game service: ${GAME_TIME}ms"
          echo "Tournament service: ${TOURNAMENT_TIME}ms"
          echo "User service: ${USER_TIME}ms"
          
          # Fail if any service takes longer than 100ms on average
          THRESHOLD=100
          
          if (( $(echo "$AUTH_TIME > $THRESHOLD" | bc -l) )); then
            echo "❌ Auth service too slow: ${AUTH_TIME}ms > ${THRESHOLD}ms"
            exit 1
          fi
      
      - name: Upload load test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: '*-load-test.txt'
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  docker-performance:
    name: Docker Build Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Measure build time - Auth Service
        run: |
          START=$(date +%s)
          docker build -t auth-service:test auth-service/
          END=$(date +%s)
          DURATION=$((END - START))
          echo "Auth service build time: ${DURATION}s"
          echo "auth_build_time=${DURATION}" >> $GITHUB_ENV
      
      - name: Measure image size
        run: |
          AUTH_SIZE=$(docker images auth-service:test --format "{{.Size}}")
          echo "Auth service image size: $AUTH_SIZE"
          echo "auth_image_size=$AUTH_SIZE" >> $GITHUB_ENV
      
      - name: Generate performance report
        run: |
          echo "# Docker Build Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Build Time | Image Size |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | ${{ env.auth_build_time }}s | ${{ env.auth_image_size }} |" >> $GITHUB_STEP_SUMMARY

  memory-test:
    name: Memory Usage Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start services
        run: |
          docker compose up -d
          sleep 30
      
      - name: Check memory usage
        run: |
          echo "Checking container memory usage..."
          docker stats --no-stream --format "table {{.Container}}\t{{.MemUsage}}\t{{.MemPerc}}" | tee memory-stats.txt
      
      - name: Validate memory limits
        run: |
          echo "Checking for memory leaks or excessive usage..."
          
          # Get memory percentages for each service
          AUTH_MEM=$(docker stats --no-stream --format "{{.MemPerc}}" auth-service | sed 's/%//')
          GAME_MEM=$(docker stats --no-stream --format "{{.MemPerc}}" game-service | sed 's/%//')
          
          echo "Auth service memory: ${AUTH_MEM}%"
          echo "Game service memory: ${GAME_MEM}%"
          
          # Warn if any service uses more than 50% memory
          if (( $(echo "$AUTH_MEM > 50" | bc -l) )); then
            echo "⚠️  Auth service using high memory: ${AUTH_MEM}%"
          fi
      
      - name: Upload memory stats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-stats
          path: memory-stats.txt
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  frontend-performance:
    name: Frontend Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: frontend
        run: |
          START=$(date +%s)
          npm run build
          END=$(date +%s)
          DURATION=$((END - START))
          echo "Frontend build time: ${DURATION}s"
          echo "frontend_build_time=${DURATION}" >> $GITHUB_ENV
      
      - name: Check bundle size
        working-directory: frontend
        run: |
          echo "Checking bundle sizes..."
          du -sh dist/* | sort -h
          
          TOTAL_SIZE=$(du -sh dist/ | awk '{print $1}')
          echo "Total bundle size: $TOTAL_SIZE"
          echo "bundle_size=$TOTAL_SIZE" >> $GITHUB_ENV
      
      - name: Generate frontend performance report
        run: |
          echo "# Frontend Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build Time: ${{ env.frontend_build_time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle Size: ${{ env.bundle_size }}" >> $GITHUB_STEP_SUMMARY

  database-performance:
    name: Database Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start services
        run: |
          docker compose up -d
          sleep 30
      
      - name: Run database stress test
        run: |
          echo "Testing database operations..."
          
          # Create many users
          for i in {1..100}; do
            curl -s -X POST http://localhost/api/auth/register \
              -H "Content-Type: application/json" \
              -d "{\"username\":\"perftest$i\",\"email\":\"perftest$i@example.com\",\"password\":\"test123\"}" \
              > /dev/null
          done
          
          echo "✅ Created 100 test users"
          
          # Query user stats
          START=$(date +%s%3N)
          curl -s http://localhost/api/user/stats/1 > /dev/null
          END=$(date +%s%3N)
          QUERY_TIME=$((END - START))
          
          echo "User stats query time: ${QUERY_TIME}ms"
          
          if [ $QUERY_TIME -gt 500 ]; then
            echo "⚠️  Database query slow: ${QUERY_TIME}ms"
          fi
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [load-test, docker-performance, memory-test, frontend-performance, database-performance]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# Performance Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All performance tests completed. Check individual jobs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests Run" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Load Testing" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Docker Build Performance" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Memory Usage Testing" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Frontend Performance" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Database Performance" >> $GITHUB_STEP_SUMMARY
