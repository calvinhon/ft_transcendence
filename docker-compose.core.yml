# Docker Compose - Core Services Only (No Monitoring)
# Use this for faster startup during development

services:
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "dev-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://127.0.0.1:8200"
    cap_add:
      - IPC_LOCK
    mem_limit: 256m
    networks:
      - transcendence-network

  hardhat-node:
    build:
      context: ./blockchain
      dockerfile: Dockerfile
    container_name: hardhat-node
    ports:
      - "8545:8545"
    mem_limit: 512m
    networks:
      - transcendence-network
    healthcheck:
      test: ["CMD-SHELL", "curl -X POST -H 'Content-Type: application/json' --data '{\"jsonrpc\":\"2.0\",\"method\":\"net_version\",\"params\":[],\"id\":1}' http://localhost:8545 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
      - JWT_SECRET=your-secret-key-here-change-in-production
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=dev-token
    depends_on:
      vault:
        condition: service_started
    mem_limit: 512m
    networks:
      - transcendence-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:3000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=production
      - AUTH_SERVICE_URL=http://auth-service:3000
    depends_on:
      auth-service:
        condition: service_healthy
    mem_limit: 512m
    networks:
      - transcendence-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:3000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  game-service:
    build:
      context: ./game-service
      dockerfile: Dockerfile
    container_name: game-service
    ports:
      - "3003:3000"
    environment:
      - NODE_ENV=production
      - AUTH_SERVICE_URL=http://auth-service:3000
    depends_on:
      auth-service:
        condition: service_healthy
    mem_limit: 512m
    networks:
      - transcendence-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:3000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  tournament-service:
    build:
      context: ./tournament-service
      dockerfile: Dockerfile
    container_name: tournament-service
    ports:
      - "3004:3000"
    environment:
      - NODE_ENV=production
      - AUTH_SERVICE_URL=http://auth-service:3000
      - BLOCKCHAIN_RPC_URL=http://hardhat-node:8545
    depends_on:
      auth-service:
        condition: service_healthy
      hardhat-node:
        condition: service_healthy
    mem_limit: 512m
    networks:
      - transcendence-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:3000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "80:80"
    environment:
      - AUTH_SERVICE_URL=http://auth-service:3000
      - USER_SERVICE_URL=http://user-service:3000
      - GAME_SERVICE_URL=http://game-service:3000
      - TOURNAMENT_SERVICE_URL=http://tournament-service:3000
    depends_on:
      - auth-service
      - user-service
      - game-service
      - tournament-service
    mem_limit: 256m
    networks:
      - transcendence-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:80 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

networks:
  transcendence-network:
    driver: bridge


